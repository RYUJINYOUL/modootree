rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // 기본 함수
    function isAuthenticated() {
      return request.auth != null;
    }

    // 이미지 파일 검증
    function isImageFile() {
      return request.resource.contentType.matches('image/.*');
    }

    // 파일 크기 검증 (10MB)
    function isValidFileSize() {
      return request.resource.size <= 10 * 1024 * 1024;
    }

    // 사용자 권한 확인
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // 허용된 사용자 확인 함수
    function isAllowedUser(userId) {
      return isAuthenticated() && (
        request.auth.uid == userId ||  // 페이지 소유자
        // 허용된 사용자 확인
        exists(/databases/$(database)/documents/users/$(userId)/settings/permissions) &&
        get(/databases/$(database)/documents/users/$(userId)/settings/permissions).data.allowedUsers.hasAny([{'email': request.auth.token.email}])
      );
    }

    // 업로드 기본 폴더 (Gallery3, 링크 이미지 등)
    match /uploads/{type}/{fileName} {
      allow read: if true;
      allow write: if isAuthenticated() && isImageFile() && isValidFileSize();
      allow delete: if isAuthenticated();
    }

    // 메모 이미지
    match /memos/{userId}/{fileName} {
      allow read: if true;
      allow write: if isAuthenticated() && isOwner(userId) && isImageFile() && isValidFileSize();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // 좋아요/공감 이미지
    match /likes/{userId}/{fileName} {
      allow read: if true;
      allow write: if isAuthenticated() && isOwner(userId) && isImageFile() && isValidFileSize();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // 다이어리 이미지
    match /diary/{userId}/{fileName} {
      allow read: if true;
      allow write: if isAllowedUser(userId) && isImageFile() && isValidFileSize();
      allow delete: if isAllowedUser(userId);
    }

    // 캘린더 이미지
    match /calendar/{userId}/{fileName} {
      allow read: if true;
      allow write: if isAllowedUser(userId) && isImageFile() && isValidFileSize();
      allow delete: if isAllowedUser(userId);
    }

    // 투표 이미지
    match /votes/{userId}/{fileName} {
      allow read: if true;
      allow write: if isAuthenticated() && isOwner(userId) && isImageFile() && isValidFileSize();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // 배경 이미지 (개인)
    match /backgrounds/{userId}/{fileName} {
      allow read: if true;
      allow write: if isAuthenticated() && isOwner(userId) && isImageFile() && isValidFileSize();
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // 배경 이미지 (공유)
    match /backgrounds/{fileName} {
      allow read: if true;
      allow write: if isAuthenticated() && isImageFile() && isValidFileSize();
      allow delete: if isAuthenticated();
    }

    // AI 아트워크 이미지
    match /artworks/{fileName} {
      allow read: if true;
      allow write: if isImageFile() && isValidFileSize();
      allow delete: if isAuthenticated();
    }

    // 나머지 모든 파일에 대한 기본 규칙
    match /{allPaths=**} {
      allow read: if true;
      allow write: if isAuthenticated() && isImageFile() && isValidFileSize();
    }
  }
}